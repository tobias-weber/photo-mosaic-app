<button class="btn btn-secondary mb-3" routerLink="../../">Back</button>


@let j = job();
@if (j) {
    <div class="d-flex justify-content-between align-items-center">
        <h1>{{ j.startedAt | date:'short' }}</h1>

        @if (mosaic()?.url) {
            <div>
                <a class="btn btn-primary" [href]="mosaic()?.url" download="mosaic_{{jobId()}}.jpg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="pb-1">
                        <g fill="none">
                            <path
                                d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/>
                            <path fill="currentColor"
                                  d="M20 14.5a1.5 1.5 0 0 1 1.5 1.5v4a2.5 2.5 0 0 1-2.5 2.5H5A2.5 2.5 0 0 1 2.5 20v-4a1.5 1.5 0 0 1 3 0v3.5h13V16a1.5 1.5 0 0 1 1.5-1.5m-8-13A1.5 1.5 0 0 1 13.5 3v9.036l1.682-1.682a1.5 1.5 0 0 1 2.121 2.12l-4.066 4.067a1.75 1.75 0 0 1-2.474 0l-4.066-4.066a1.5 1.5 0 0 1 2.121-2.121l1.682 1.682V3A1.5 1.5 0 0 1 12 1.5"/>
                        </g>
                    </svg>
                    Download
                </a>
            </div>
        }
    </div>


    @if (!isComplete()) {
        <div class="position-relative d-flex justify-content-center preview-container mb-3">
            @if (hasPreview()) {
                <img [src]="mosaic()?.url" class="mosaic-img rounded" alt="Mosaic Preview">
            } @else if (targetImage()) {
                <img [src]="targetImage()?.url" class="mosaic-img rounded" alt="Target">
            }
            <div class="position-absolute top-50 start-50 translate-middle">
                <button class="btn btn-light btn-lg d-flex flex-column status-button" type="button" disabled>
                    <div class="d-flex align-items-center">
                        <span class="spinner-border" aria-hidden="true"></span>
                        <span role="status" class="ms-3">{{ statusText() }}</span>
                    </div>
                    @if (j.status === JobStatus.Processing) {
                        <div style="min-width: 300px">
                            <ngb-progressbar class="mt-3" type="primary" [value]="j.progress * 100" [striped]="true"/>
                        </div>
                    }
                </button>
            </div>
        </div>

    }

    @if (j.status === JobStatus.Finished) {
        <div class="mb-5">
            <app-mosaic-viewer [jobId]="j.jobId"></app-mosaic-viewer>
        </div>

        <h3 class="text-center">Target Image</h3>
        <div class="d-flex justify-content-center preview-container mb-3">
            <img [src]="targetImage()?.url" class="full-width-img" alt="Target">
        </div>
    } @else if (j.status === JobStatus.Failed) {
        <div class="alert alert-danger" role="alert">
            The mosaic creation has failed. Please try again.
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-6 col-lg-4 mb-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ JobStatus[j.status] }}</h5>
                    <p class="card-text">Number of Tiles: {{ j.n }}</p>
                    <p class="card-text">Subdivisions: {{ j.subdivisions }}</p>
                    <p class="card-text">Repetitions: {{ j.repetitions }}</p>
                    <p class="card-text">Crop Count: {{ j.cropCount }}</p>

                    @if (isComplete()) {
                        <p class="card-text">Finished: {{ j.finishedAt | date:'short' }}</p>
                    }
                </div>
            </div>
        </div>
    </div>
}
